## ZUDP

----

本文记录了这次设计的，实现可靠传输功能的 UDP 协议。（无比简陋，写上 UDP 的名字也挺丢人的，但是也不知道该叫啥别的了）

在应用层中，发送的包最开始的部分是 SNMPv1 的（某个）首部，以及 PDU 部分的键值对的长度。（用以骗过内网中的安全设备，使得整个包被识别为 SNMP 包）

之后，是 ZUDP 的首部，包含实际传输的数据的一些属性字段；再之后是实际传输的数据。



本文介绍的是 SNMP 语境相关的内容，因此以下的客户端指某个网络设备，服务端指被直接操作的主机。下面简单说明传输过程。

### 传输过程

---

以向客户端上传文件为例。

- 服务端在准备发送之前，先向客户端发送一个包，表示通知开始文件传送，包含了接下来的一组包的状态信息；
- 客户端向服务端发送一个包，表示准备接受后面的文件；
- 服务端按顺序向客户端传送包含文件信息的这一组包中的某一个；
- 客户端向服务端发送一个“收到确认”包，表示接收完毕、成功；
- 回到上面的第三步直到传输完毕。

上述所有的传输过程都是直接使用 UDP Socket 接口实现的，而如果某个包传输的过程中出现了丢包的现象，最终客户端不会向服务端返回成功标志，而是返回失败包，并在其中告知丢失的包的索引数。服务端会根据这个包的信息开始**重发**。

如果某个包在多次传输中始终不能到达，那么当达到某个预先设定的临界值的时候，将停止这个文件传输，表示传送失败。（这个部分也可能因为时间问题而鸽掉，毕竟这种网络严重拥堵的情况在测试中往往不会出现...）

### ZUDP 报文格式

----

下面的偏移量从记录的 SNMP 报文首部末（实际有了一小部分 PDU，但总之就是 SNMP 的部分后）开始计算。



#### 对于文件包

|   偏移量   |                  字段                  |
| :--------: | :------------------------------------: |
|    0x00    |                传输状态                |
|    0x01    | 包文件类型（命令、文本、图片、视频等） |
|    0x02    |       包索引（传输多包文件的话）       |
|    0x04    |             数据字段的长度             |
|    0x05    |              文件名的长度              |
|    0x06    |                 文件名                 |
| 0x06 + len |                文件内容                |



#### 对于通知包

| 偏移量 |              字段              |
| :----: | :----------------------------: |
|  0x00  |            传输状态            |
|  0x01  |           包文件类型           |
|  0x02  |   包索引（传输多包文件的话）   |
|  0x04  |     这个文件的数据包的总数     |
|  0x06  | 是否丢包（对于当前文件包来说） |
|  0x07  |           文件名长度           |
|  0x08  |             文件名             |









----



传输状态编码（1B）

|           传输状态值           | 编码 |
| :----------------------------: | :--: |
|   通知即将开始传送（Step 1）   | 0x00 |
|   回复可以接受传送（Step 2）   | 0x01 |
| 这个包传输了实际数据（Step 3） | 0x02 |
|           包接受成功           | 0x03 |
|          丢包请求重传          | 0x04 |



包文件类型编码（1B）

|   包文件类型   | 编码 |
| :------------: | :--: |
| 不指定文件类型 | 0x00 |
|      命令      | 0x01 |
|   纯文本文件   | 0x02 |
|    图片文件    | 0x03 |
|    视频文件    | 0x04 |



根据计算...由于 SNMP 包比较小，只有一个字节的长度字段，于是这个协议单次可以传送的最大的文件是 12MB 左右。

